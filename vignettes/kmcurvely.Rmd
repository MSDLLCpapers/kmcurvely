---
title: "Generate Kaplan-Meier curves plot for time-to-event analysis"
author: "Li Ma"
output: 
  rmarkdown::html_document:
      self_contained: no
      number_sections: yes
      code_folding: hide
  vignette: |
    %\VignetteIndexEntry{Generate Kaplan-Meier curves plot for time-to-event analysis}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  eval = TRUE,
  echo = TRUE
)
```

# Introduction

The `kmcurvely` R package creates Kaplan-Meier curves plot for clinical trial analysis and reporting in terms of time-to-event analysis. 

Through its interactive features, users can: 

- **Search** for the ENDPOINT or SUBGROUP of interest.
- **Selection** to view single/multiple ENDPOINT or SUBGROUP of interest.

# Procedure to generate interactive forest plot

## Step 1: Read data

In the example presented in this vignette, we utilize `meta_tte_example` function in the `kmcurvely` to create a list output (meta) containing metadata structured for time-to-event analysis.

```{r message=FALSE}
library(dplyr)
library(survival)
library(ggplot2)
library(plotly)
library(htmlwidgets)
library(kmcurvely)

meta <- meta_tte_example()
```

## Step 2: Generate KM plot (interactive)

We generate the data required for plotting Kaplan-Meier curves by using the `kmcurvely` function. In this example, we extract the data for the "apat" population, focusing on the "efficacy_population" observation, the "pfs" endpoint, and gender subgroups.

```{r}
kmcurvely(
  meta = meta,
  population = "apat",
  observation = "efficacy_population",
  endpoint = "pfs",
  subgroup = "male;female"
)
```
## Step 3: Generate KM plot (static)

We create key data objects containing survival data, at-risk tables, axis labels, color schemes, and plot limits, which are essential for creating the Kaplan-Meier curves and attached it as an attribute to the "kmcur_data" object.

```{r}
kmcur_data <- kmcurvely(
  meta = meta,
  population = "apat",
  observation = "efficacy_population",
  endpoint = "pfs",
  subgroup = "male;female"
)
```

Extract key data objects from "key_data_objects" attribute that has been saved to the "kmcur_data" object.


```{r}
key_data <- attr(kmcur_data, "key_data_objects")
```
Then, create static Kaplan-Meier plots via `kmcurvely_static` function with the key data objects extracted from the "kmcur_data". 

```{r}
out_kmplot <- kmcurvely_static(
  surv_shared = key_data$tbl_surv,
  tbl_at_risk = key_data$tbl_at_risk,
  x_label = key_data$x_label,
  y_label = key_data$y_label,
  color = key_data$color,
  xlimit = key_data$xlimit,
  break_x_by = key_data$break_x_by,
  population = key_data$population
)
```
The resulting plots are saved as RTF/PNG files for reporting purposes.
In the example, we copy the output zip file to the "tests/testthat/_snaps" directory for snapshot testing and demonstration purpose.  The path is subject to change based on your project structure.

```{r}
# Define destination directory for snapshots
dest_dir <- file.path(getwd(), "tests", "testthat", "_snaps")

# Ensure destination directory exists
if (!dir.exists(dest_dir)) {
  dir.create(dest_dir, recursive = TRUE)
}

# Copy the output zip file to the destination directory
file.copy(from = out_kmplot, to = dest_dir, overwrite = TRUE)
```

                        
